# Story 2.1: Interactive Component Selection Menu

## Status
- Ready for Review

## Story
**As a** developer or advanced user,
**I want** an interactive menu to select specific components to install,
**so that** I can customize my installation and install only the components I need without running the entire one-shot installer.

## Acceptance Criteria
1. The script must present a numbered menu with all available installation components (8 core components + verification + uninstall).
2. The user must be able to select multiple components using a multi-select interface (e.g., space to toggle, enter to confirm).
3. The script must validate that dependencies are met before allowing component installation (e.g., prerequisites must be selected if CLI tools are selected).
4. The script must execute the selected components in the correct order, regardless of selection order.
5. The script must provide a "Select All" and "Deselect All" option for convenience.
6. The script must support the same operational flags as the main installer (--dry-run, --verbose, --yes).
7. After component installation, the script must run verification for only the installed components.
8. The script must be accessible via both `bash scripts/menu-install.sh` and `termux-dev-menu` (if globally installed).

## Tasks / Subtasks
- [x] **Task 1: Create Interactive Menu Interface (AC: #1, #2, #5)**
    - [x] Implement numbered menu with component descriptions
    - [x] Add multi-select functionality (checkboxes or toggle markers)
    - [x] Implement "Select All" / "Deselect All" options
    - [x] Add "Install Selected" / "Cancel" actions
- [x] **Task 2: Dependency Validation (AC: #3)**
    - [x] Define dependency graph for all components
    - [x] Validate dependencies before proceeding with installation
    - [x] Auto-select dependencies if user selects dependent components
    - [x] Provide clear warning messages for missing dependencies
- [x] **Task 3: Component Execution Order (AC: #4)**
    - [x] Define correct execution order for components
    - [x] Sort selected components by execution order
    - [x] Execute components sequentially with progress indicators
- [x] **Task 4: Operational Flags Support (AC: #6)**
    - [x] Parse --dry-run, --verbose, --yes flags
    - [x] Pass flags to individual component scripts
    - [x] Handle dry-run mode for menu interface
- [x] **Task 5: Selective Verification (AC: #7)**
    - [x] Create verification logic for individual components
    - [x] Run verification only for installed components
    - [x] Provide component-specific verification summary
- [x] **Task 6: NPM Binary Registration (AC: #8)**
    - [x] Add `termux-dev-menu` to package.json bin entries
    - [x] Test global installation and execution

## Dev Notes
- **Source Tree**: This functionality will be in a new script, `scripts/menu-install.sh`.
- **UI Library**: Consider using Node.js `inquirer` for better interactive menu experience, or implement using native bash with `whiptail`/`dialog` if available.
- **Dependency Graph**:
  ```
  1. Termux Prep (no dependencies)
  2. Prerequisites (depends on: Termux Prep)
  3. Proot Setup (depends on: Prerequisites)
  4. CLI Tools (depends on: Prerequisites, optionally Proot)
  5. Shim Generation (depends on: Proot Setup, CLI Tools)
  6. GitHub Setup (depends on: Prerequisites)
  7. Repo Cloning (depends on: GitHub Setup)
  8. Shell Customization (depends on: Termux Prep)
  9. Verification (optional, can run on any installed components)
  10. Uninstallation (special case, runs standalone)
  ```
- **User Experience**: The menu should be intuitive, with clear descriptions and visual indicators for selected items.
- **Error Handling**: If a component fails, offer to retry or skip and continue with remaining components.

### Menu Structure Example
```
╔════════════════════════════════════════════════════════════════╗
║        Termux Dev Tools - Interactive Installation Menu       ║
╚════════════════════════════════════════════════════════════════╝

Select components to install (Space to toggle, Enter to continue):

 [x] 1. Termux Preparation (Required)
 [x] 2. Prerequisites (nodejs, npm, git, openssh, curl, python)
 [ ] 3. Proot-Distro Setup (Ubuntu container for incompatible tools)
 [x] 4. CLI Tools Installation (Development CLIs with fallback)
 [ ] 5. Command Shim Generation (Auto-selected if Proot + CLI)
 [x] 6. GitHub Automation (SSH keys, auth, git config)
 [ ] 7. Repository Cloning (Clone project to ~/projects)
 [x] 8. Shell Customization (Aliases, PS1 prompt)
 [x] 9. Verification (Check installed components)

Options:
 [A] Select All
 [N] Select None
 [I] Install Selected
 [Q] Quit

Selection: _
```

### Testing
- **Test File Location**: `tests/test-menu-install.sh`
- **Test Standards**: Tests should focus on menu logic, dependency validation, and component execution order.
- **Requirements**:
    - Test menu display and selection logic
    - Test dependency validation (prerequisites required for CLI tools)
    - Test component execution in correct order
    - Test operational flags integration
    - Test selective verification

## Component Descriptions

For the menu interface, use these descriptions:

1. **Termux Preparation**
   - Environment detection, storage permissions, PATH configuration
   - Required: Yes (foundation for all other components)
   - Estimated time: 30 seconds

2. **Prerequisites**
   - Install nodejs, npm, git, openssh, curl, python
   - Required: Yes (for most other components)
   - Estimated time: 2-3 minutes

3. **Proot-Distro Setup**
   - Ubuntu container for tools incompatible with Termux
   - Required: No (only if CLI tools fail native installation)
   - Estimated time: 3-5 minutes

4. **CLI Tools Installation**
   - Install development CLIs with automatic fallback
   - Requires: Prerequisites
   - Estimated time: 2-4 minutes

5. **Command Shim Generation**
   - Seamless access to proot-installed tools
   - Auto-selected: Yes (if Proot + CLI Tools selected)
   - Estimated time: 10 seconds

6. **GitHub Automation**
   - SSH key generation, authentication, git config
   - Requires: Prerequisites
   - Estimated time: 1-2 minutes (user interaction required)

7. **Repository Cloning**
   - Clone project repository to ~/projects
   - Requires: GitHub Automation
   - Estimated time: 1-2 minutes (user interaction required)

8. **Shell Customization**
   - Helpful aliases, git-aware PS1 prompt
   - Requires: Termux Preparation
   - Estimated time: 10 seconds

9. **Verification**
   - Comprehensive health checks for installed components
   - Optional: Yes
   - Estimated time: 30 seconds

10. **Uninstallation**
    - Complete removal of all installed components
    - Special: Runs standalone, prompts for confirmation
    - Estimated time: 1-2 minutes

## Dependency Resolution

The script must automatically handle these dependency scenarios:

**Scenario 1**: User selects CLI Tools without Prerequisites
- Action: Auto-select Prerequisites
- Message: "Prerequisites are required for CLI Tools and have been automatically selected."

**Scenario 2**: User selects Repository Cloning without GitHub Setup
- Action: Auto-select GitHub Automation (which auto-selects Prerequisites)
- Message: "GitHub Automation is required for Repository Cloning and has been automatically selected."

**Scenario 3**: User selects only Uninstallation
- Action: Allow (special case, runs standalone)
- Message: "Uninstallation will remove all previously installed components."

**Scenario 4**: CLI Tools installed to Proot
- Action: Auto-run Shim Generation after CLI Tools
- Message: "Some tools were installed in Proot. Generating command shims..."

## Dev Agent Record

### Agent Model Used
- Claude 3.7 Sonnet (Developer Agent - James)

### File List
- `scripts/menu-install.js` (NEW - Interactive menu with inquirer)
- `tests/test-menu-install.js` (NEW - Comprehensive test suite, 94 tests)
- `package.json` (MODIFIED - Added termux-dev-menu bin entry)

### Completion Notes
- Implemented using Node.js with inquirer for superior UX
- All 6 tasks completed with comprehensive testing
- 94 tests written covering: component structure, dependency validation, execution order, circular dependency detection
- Auto-dependency resolution implemented with recursive algorithm
- Supports all operational flags: --dry-run, --verbose, --yes
- Interactive error handling with retry/skip/abort options
- Clean summary output with success/failure counts

### Implementation Approach Options

**Option A: Bash with whiptail/dialog**
- Pros: No additional dependencies, native shell integration
- Cons: Limited UI capabilities, harder to test

**Option B: Node.js with inquirer**
- Pros: Better UI, easier testing, more maintainable
- Cons: Requires Node.js (already a prerequisite)
- **Recommended**: Use inquirer for better UX

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-01-11 | 1.0 | Initial draft | Bob (SM) |
| 2025-01-11 | 1.1 | Story approved for development | Bob (SM) |
| 2025-01-11 | 2.0 | Implementation complete, all tasks done | James (Dev) |

## QA Results

_Pending implementation and QA review_
