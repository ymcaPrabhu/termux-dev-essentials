#! /usr/bin/env node

var cli = require('cmdl'),
    colors = require('colors'),
    async = require('async'),
    cdx = require('../lib/codex-cli')(cli),
    cliName = 'codex.' + 'js'.red,
    blogTitle;

cli.init({
    version: '0.1.0',
    name: cliName,
    enablePrompt: true
});

cli.addOption({
    name: 'create',
    short: 'c',
    type: 'string',
    description: 'Creates a new blog',
    example: 'codex -c my_cool_blog',
    callback: function(blogName) {
        //TODO: throw error if title has spaces
        blogTitle = blogName;

        async.series({
            folder: function(callback) {
                cdx.sendMessage('Creating folder...');
                cdx.createBlogFolder(blogTitle, callback);
            },
            files: function(callback) {
                cdx.sendMessage('Cloning blog files...');
                cdx.checkoutBlogFiles(blogTitle, callback);
            },
            config: function(callback) {
                cdx.sendMessage('Setting up MongoDB...');
                cdx.createConfigFile(blogTitle, callback);
            },
            admin: function(callback) {
                cdx.sendMessage('Creating admin user for the blog...');
                cdx.createBlogAdmin(blogTitle, callback);
            }
        }, function(err, res) {
            if(err) {
                cdx.sendError(err);
            } else {
                cdx.sendSuccess('Done! Now, type:');
                cdx.sendSuccess('   cd ' + blogTitle);
                cdx.sendSuccess('   npm install && bower install && npm start');
            }
        });
    }
});

cli.listen();